<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Systemd - partie 2 | Yet another tech blog</title><meta name=keywords content="linux,systemd,init system"><meta name=description content="A l'intérieur de systemd"><meta name=author content="Cyrille Sondag"><link rel=canonical href=https://cyrillesondag.github.io/blog/systemd-part-two/><link crossorigin=anonymous href=/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css integrity="sha256-NDzEgLn/yPBMy+XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as=style><link rel=icon href=https://cyrillesondag.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://cyrillesondag.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://cyrillesondag.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://cyrillesondag.github.io/apple-touch-icon.png><link rel=mask-icon href=https://cyrillesondag.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://cyrillesondag.github.io/blog/systemd-part-two/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://cyrillesondag.github.io/blog/systemd-part-two/"><meta property="og:site_name" content="Yet another tech blog"><meta property="og:title" content="Systemd - partie 2"><meta property="og:description" content="A l'intérieur de systemd"><meta property="og:locale" content="fr-fr"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-02-06T23:24:56+02:00"><meta property="article:modified_time" content="2025-12-02T17:43:25+01:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Systemd"><meta name=twitter:card content="summary"><meta name=twitter:title content="Systemd - partie 2"><meta name=twitter:description content="A l'intérieur de systemd"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://cyrillesondag.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Systemd - partie 2","item":"https://cyrillesondag.github.io/blog/systemd-part-two/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Systemd - partie 2","name":"Systemd - partie 2","description":"A l'intérieur de systemd","keywords":["linux","systemd","init system"],"articleBody":" Gustave Caillebotte - Périssoires sur l’Yerres (1877), huile sur toile, 103 × 155 cm, Milwaukee (USA), Milwaukee Art Museum.\nNous avons vu dans le précédent article quelques différences entre SysV init et systemd, ainsi que le mécanisme d’initialisation de l’espace utilisateur par le kernel. Dans cet article, je vais aborder plus en détail le fonctionnement de systemd.\nLes Managers L’objet manager est central, il contient les valeurs par défaut des différentes propriétés du système et est responsable de la gestion des units qui lui sont attachées. C’est avec lui que les “utilisateurs” vont communiquer.\nIl est chargé de propager les actions appelées job (par exemple : start, stop, reload…) vers les units et d’interagir avec les éléments tiers du système (watchdog, inotify, D-bus, cgroups…).\nIl en existe sous 2 formes ayant chacune des portées différentes :\nLa première (celle par défaut) appelée “system” est unique par machine et est normalement lancée par le processus d’init avec les droits root.\nOn peut vérifier que systemd est bien l’init manager du système de la façon suivante :\n1 2 # ls -ls /usr/sbin/init /usr/sbin/init -\u003e /lib/systemd/systemd Ou plus simplement utiliser cette commande :\n1 systemctl La seconde est “user”, il est unique par utilisateur et hérite des mêmes droits que ce dernier. Ce type d’instance s’avère particulièrement utile pour limiter les droits des services qui lui sont associés (rootless).\nPour connaître l’état d’une instance utilisateur on peut utiliser la commande suivante :\n1 systemctl --user Bien spécifier l’argument --user devant toutes les commandes pour interagir avec l’instance de l’utilisateur.\nLa gestion des Units On l’a vu les managers sont responsables de la gestion des units.\nUne unit chargée par un manager elle est unique si son nom est unique (pour les templates, les alias, les fragments, le nom est résolu au runtime).\nLes units files sont lues au premier “référencement” (par exemple lors de leur activation, ou bien via de liens de dépendances…), transformées en unit et mise en cache dans la mémoire du manager qui leur est associé.\nElles sont stockées à l’intérieur d’une HashMap sous la forme nom/valeur (d’où leur unicité).\nPour cette raison, il faut forcer le ramasse-miette (GC) ce qui a pour effet de sérialiser sur disque l’état des units actives, vider le cache du manager et recharger la configuration des units via leurs unit file (ce n’est pas néanmoins pas toujours nécessaire, mais ça évite des erreurs).\nPour forcer le ramasse miette on utilise la commande suivante :\n1 systemctl daemon-reload Arborescence et précédence La définition des unit files répondent à une précédence très précise utilisée afin de faciliter l’administration du système et sa mise à jour.\nPar ordre d’importance croissante (non exhaustif) en mode “–system” :\n/lib/systemd/system/* : installés par le gestionnaire de paquets (il est recommandé d’éviter de les modifier sous peine de pertes lors des mises à jour du paquet) /usr/local/lib/systemd/system/* : gérés par l’administrateur /run/systemd/system/* : générées au runtime /etc/systemd/system/* : gérés par l’administrateur Ainsi une unit file définie dans le répertoire /etc/systemd/system/* sera prioritaire sur celle définie dans /lib/systemd/system/*\nEn mode “–user” la hiérarchie est un peu différente :\n/lib/systemd/user/* : installés par le gestionnaire de paquets (ne doivent pas être modifiés sous peine de pertes lors des mises à jour) /usr/local/lib/systemd/user/* : gérés par l’administrateur /run/systemd/user/* : générées au runtime /etc/systemd/user/* : gérés par l’administrateur ~/.config/systemd/user/* : géré par l’utilisateur Ça peut paraître compliqué aux premiers abords, mais limite le périmètre des différents intervenants sur une machine (utilisateurs, administrateurs, packageurs…) pour qu’ils ne se marchent sur les pieds.\nDe plus des outils spécifiques sont fournis (on le verra plus loin) pour aider à la compréhension de ce mécanisme.\nFragment Configuration Les fragments configuration sont des fichiers qui permettent de modifier les propriétés d’une ou d’un groupe de units sans avoir à la/les redéfinir entièrement. Ces fichiers répondent aux mêmes ordres de précédence que nous venons d’aborder plus haut.\nPour surcharger, il est possible de définir des fichiers .conf qui seront lus par ordre alphabétique dans les formats suivants :\nPar type de unit sous la forme .d/*.conf. Ainsi un fragment dans un répertoire service.d/*.conf s’appliquera à tous les *.service Une unit spécifique sous la forme .d/*.conf Ou grâce à une pseudo hiérarchie et l’utilisation du signe ‘-’ dans le nom des units. Ainsi un fragment de configuration dans le répertoire foo-.d/*.conf va surcharger les configurations des units foo-bar.service, foo-foo.service et foo-bar-foo.service… Voyons maintenant comment appliquer cela et les outils fournis par systemd pour nous assister dans la mise en place.\nSi l’on crée le fichier /etc/systemd/system/service1.service de la façon suivante :\n1 2 3 [Service] Type=oneshot ExecStart=/bin/echo hello world Puis le fragment de configuration dans le fichier suivant /etc/systemd/system/service1.service.d/00-override.conf :\n1 2 [Service] ExecStart=/bin/echo running this first Puis le fichier suivant /etc/systemd/system/service.d/00-override.conf :\n1 2 [Service] ExecStart=/bin/echo top level exec pre start On obtient en utilisant la commande systemctl cat le détail de la configuration de la unit ainsi que ses différents fragments :\n1 2 3 4 5 6 7 8 9 10 11 12 $ systemctl cat service1.service # /etc/systemd/system/service1.service [Service] ExecPreStart=/bin/echo hello world # /etc/systemd/system/service1.service.d/00-override.conf [Service] ExecPreStart=/bin/echo running this first # /etc/systemd/system/service.d/00-override.conf [Service] ExecPreStart=/bin/echo top level exec pre start Et produit le résultat suivant :\n1 2 3 top level exec pre start running this first hello world Il est intéressant de noter que les surcharges sont additives. Pour passer outre les précédentes définitions, il faut d’abord déclarer la propriété à vide avant de la surcharger avec la valeur attendue.\n1 2 3 [Service] ExecStart= ExecStart=/bin/echo top level exec pre start Les Units Les units sont les éléments de bases de systemd. Il existe 11 types différents de unit. Ils correspondent chacun à un type d’actions particulières.\nLe type d’une unit est déterminé par le suffix de son unit file :\n*.service : Qui permet de définir un groupe de processus. C’est l’objet qu’on est le plus souvent amené à utiliser. *.socket : Pour faire de l’activation de services par sockets (IPC, network, unix socket…). *.device : Pour prendre en compte l’activation par périphériques via udev (dont le hot-plug). *.mount : Pour gérer le montage de partitions. *.automount : Qui permet l’activation des units .mount automatique lors du premier accès. *.swap : Configuration d’un point de montage swap *.target : Sont des point de synchronisation d’un ensemble de units (comme les run-levels de SysVinit), mais également des points de déclenchements. *.path : Activation par observation de chemins *.timer : Déclencheur périodique (à la manière de cron) *.scope : Configuration d’un ensemble de processus externes *.slice : Qui permet de regrouper un ensemble de processus au sein d’un cgroup commun. Une unit est décrite par une unit file qui est lue au premier référencement pour être transformée en unit.\nL’objet units implémente les opérations de bases génériques, une spécialisation est faite via la structure UnitVtable qui va référencer les méthodes spécifiques à chaque type.\nVoici un exemple non exhaustif des méthodes de UnitVtable :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 typedef struct UnitVTable { /* How much memory does an object of this unit type need */ size_t object_size; /* The name of the configuration file section with the private settings of this unit */ const char *private_section; /* Config file sections this unit type understands, separated * by NUL chars */ const char *sections; /* This should reset all type-specific variables. This should * not allocate memory, and is called with zero-initialized * data. It should hence only initialize variables that need * to be set != 0. */ void (*init)(Unit *u); /* This should free all type-specific variables. It should be * idempotent. */ void (*done)(Unit *u); /* Actually load data from disk. This may fail, and should set * load_state to UNIT_LOADED, UNIT_MERGED or leave it at * UNIT_STUB if no configuration could be found. */ int (*load)(Unit *u); void (*dump)(Unit *u, FILE *f, const char *prefix); int (*start)(Unit *u); int (*stop)(Unit *u); int (*reload)(Unit *u); int (*kill)(Unit *u, KillWho w, int signo, sd_bus_error *error); /* Boils down the more complex internal state of this unit to * a simpler one that the engine can understand */ UnitActiveState (*active_state)(Unit *u); /* Return false when there is a reason to prevent this unit from being gc'ed * even though nothing references it and it isn't active in any way. */ bool (*may_gc)(Unit *u); /* Return true when the unit is not controlled by the manager (e.g. extrinsic mounts). */ bool (*is_extrinsic)(Unit *u); /* Returns the exit status to propagate in case of FailureAction=exit/SuccessAction=exit; usually returns the * exit code of the \"main\" process of the service or similar. */ int (*exit_status)(Unit *u); ..... } UnitVTable; On retrouve logiquement dans l’objet Unit l’ensemble des sous-types, qui permettra de propager les actions génériques vers leurs implementations.\n1 2 3 4 5 6 7 8 9 10 11 12 13 const UnitVTable * const unit_vtable[_UNIT_TYPE_MAX] = { [UNIT_SERVICE] = \u0026service_vtable, [UNIT_SOCKET] = \u0026socket_vtable, [UNIT_TARGET] = \u0026target_vtable, [UNIT_DEVICE] = \u0026device_vtable, [UNIT_MOUNT] = \u0026mount_vtable, [UNIT_AUTOMOUNT] = \u0026automount_vtable, [UNIT_SWAP] = \u0026swap_vtable, [UNIT_TIMER] = \u0026timer_vtable, [UNIT_PATH] = \u0026path_vtable, [UNIT_SLICE] = \u0026slice_vtable, [UNIT_SCOPE] = \u0026scope_vtable, }; Un unit a un cycle de vie, et donc un état. Les états de base sont les suivants :\nActive Reloading Inactive Failed Activating Deactivating Maintenance Cette liste d’état peut être, elle aussi, enrichie pour répondre au cycle de vie spécifique d’un type d’unit.\nPar exemple pour une unit de type service on trouve cette liste d’états qui font tous la correspondance avec les états de base.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 static const UnitActiveState state_translation_table[_SERVICE_STATE_MAX] = { [SERVICE_DEAD] = UNIT_INACTIVE, [SERVICE_CONDITION] = UNIT_ACTIVATING, [SERVICE_START_PRE] = UNIT_ACTIVATING, [SERVICE_START] = UNIT_ACTIVATING, [SERVICE_START_POST] = UNIT_ACTIVATING, [SERVICE_RUNNING] = UNIT_ACTIVE, [SERVICE_EXITED] = UNIT_ACTIVE, [SERVICE_RELOAD] = UNIT_RELOADING, [SERVICE_STOP] = UNIT_DEACTIVATING, [SERVICE_STOP_WATCHDOG] = UNIT_DEACTIVATING, [SERVICE_STOP_SIGTERM] = UNIT_DEACTIVATING, [SERVICE_STOP_SIGKILL] = UNIT_DEACTIVATING, [SERVICE_STOP_POST] = UNIT_DEACTIVATING, [SERVICE_FINAL_WATCHDOG] = UNIT_DEACTIVATING, [SERVICE_FINAL_SIGTERM] = UNIT_DEACTIVATING, [SERVICE_FINAL_SIGKILL] = UNIT_DEACTIVATING, [SERVICE_FAILED] = UNIT_FAILED, [SERVICE_AUTO_RESTART] = UNIT_ACTIVATING, [SERVICE_CLEANING] = UNIT_MAINTENANCE, }; Job et Transaction Tout changement d’état d’une unit se fait au travers d’un Job. Il existe plusieurs types de job :\nStart / Verify Stop Reload Restart Nop On trouve également d’autres types de Job qui sont la combinaison des types précédents : par exemple “try-restart” se transformera à l’exécution en “start” ou “nop” si la unit n’est pas activée ou en cours de rechargement.\nPrenons l’exemple de la unit file suivante :\n1 2 3 [Unit] Wants=multi-users.target ... La propriété Wants= a pour effet de créer une dépendance entre cette unit et la target unit “multi-user.target”.\nNB : La plupart des relations peuvent être notées dans un sens ou dans l’autre (Before=/ After=, Require=/RequiredBy=…) On pourrait donc réaliser cette même dépendance à l’aide de la propriété WantedBy= dans la target et cela aurait le même effet.\nCette dépendance va avoir pour effet de propager l’activation de la target “multi-user.target” aux unit ayant une relation de type Wants= avec elle.\nLors de cette activation une transaction qui va contenir le job d’activation de la target en elle-même plus autant de job que de dépendances.\nAinsi dans le cas d’une relation avec une unit de type Wants= la transaction pourra être mise en succès même si ce job est en échec. Ce qui n’aurait pas été le cas avec une relation plus “forte” (par exemple Require=/RequiredBy=).\nEn pratique ces relations sont spécifiées par une énumération de propriétés beaucoup plus fines les UnitDependencyAtom ou “atoms” (qui ne sont rien d’autre qu’un bitmask).\nAinsi la propriété Wants= est composée de la sorte :\n1 2 3 4 [UNIT_WANTS] = UNIT_ATOM_PULL_IN_START_IGNORED | UNIT_ATOM_RETROACTIVE_START_FAIL | UNIT_ATOM_ADD_STOP_WHEN_UNNEEDED_QUEUE | UNIT_ATOM_ADD_DEFAULT_TARGET_DEPENDENCY_QUEUE, Cela lui permet de réagir aux propriétés suivantes qui peuvent être utilisées par différents objets (transaction, units…). Sans rentrer dans les détails on retrouve l’attribut “UNIT_ATOM_PULL_IN_START_IGNORED” le comportement décrit plus haut.\nIl implémente un mécanisme de transaction connu sous le nom de Job qui s’assure de la transition d’une unit d’un état A vers un état B (par exemple start / stop / restart…).\nConclusion Vous l’avez peut-être remarqué, mais systemd est conçu comme un système orienté objet. On retrouve d’ailleurs beaucoup de principes de la POO (polymorphisme, sous-typage, redéfinition…) dans les différents points que j’ai abordés\nVoilà ainsi va se conclure cet article. Dans le prochain, nous aborderons l’architecture de systemd.\n","wordCount":"2092","inLanguage":"en","datePublished":"2022-02-06T23:24:56+02:00","dateModified":"2025-12-02T17:43:25+01:00","author":{"@type":"Person","name":"Cyrille Sondag"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://cyrillesondag.github.io/blog/systemd-part-two/"},"publisher":{"@type":"Organization","name":"Yet another tech blog","logo":{"@type":"ImageObject","url":"https://cyrillesondag.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://cyrillesondag.github.io/ accesskey=h title="Yet another tech blog (Alt + H)">Yet another tech blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://cyrillesondag.github.io/ title=Accueil><span>Accueil</span></a></li><li><a href=https://cyrillesondag.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://cyrillesondag.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://cyrillesondag.github.io/search/ title=Rechercher><span>Rechercher</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://cyrillesondag.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://cyrillesondag.github.io/blog/>Blogs</a></div><h1 class="post-title entry-hint-parent">Systemd - partie 2</h1><div class=post-description>A l'intérieur de systemd</div><div class=post-meta><span title='2022-02-06 23:24:56 +0200 +0200'>6 February 2022</span>&nbsp;·&nbsp;<span>10 min</span>&nbsp;·&nbsp;<span>Cyrille Sondag</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#les-managers aria-label="Les Managers">Les Managers</a><ul><li><a href=#la-gestion-des-units aria-label="La gestion des Units">La gestion des Units</a></li><li><a href=#arborescence-et-pr%c3%a9c%c3%a9dence aria-label="Arborescence et précédence">Arborescence et précédence</a></li><li><a href=#fragment-configuration aria-label="Fragment Configuration">Fragment Configuration</a></li></ul></li><li><a href=#les-units aria-label="Les Units">Les Units</a></li><li><a href=#job-et-transaction aria-label="Job et Transaction">Job et Transaction</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><figure><a href=Gustave_Caillebotte_-_Perissoires_sur_yerres.jpg><img sizes="(min-width: 35em) 1200px, 100vw" srcset='https://cyrillesondag.github.io/blog/systemd-part-two/Gustave_Caillebotte_-_Perissoires_sur_yerres_hu_b3e53584bfcbaeaa.jpg 480w,' src=https://cyrillesondag.github.io/blog/systemd-part-two/Gustave_Caillebotte_-_Perissoires_sur_yerres.jpg alt="Gustave Caillebotte - Périssoires sur l&rsquo;Yerres (1877), huile sur toile, 103 × 155 cm, Milwaukee (USA), Milwaukee Art Museum."></a><figcaption style=font-size:80%;text-align:center><p>Gustave Caillebotte - Périssoires sur l&rsquo;Yerres (1877), huile sur toile, 103 × 155 cm, Milwaukee (USA), Milwaukee Art Museum.</p></figcaption></figure><p><br>Nous avons vu dans le précédent article quelques différences entre SysV init et systemd, ainsi que le mécanisme d&rsquo;initialisation de l&rsquo;espace utilisateur par le kernel.
Dans cet article, je vais aborder plus en détail le fonctionnement de systemd.</p><h2 id=les-managers>Les Managers<a hidden class=anchor aria-hidden=true href=#les-managers>#</a></h2><p>L&rsquo;objet <em>manager</em> est central, il contient les valeurs par défaut des différentes propriétés du système et est responsable de la gestion des <em>units</em> qui lui sont attachées.
C&rsquo;est avec lui que les &ldquo;utilisateurs&rdquo; vont communiquer.</p><p>Il est chargé de propager les actions appelées job (par exemple : start, stop, reload&mldr;) vers les <em>units</em> et d&rsquo;interagir avec les éléments tiers du système (watchdog, inotify, D-bus, cgroups&mldr;).</p><p>Il en existe sous 2 formes ayant chacune des portées différentes :</p><p>La première (celle par défaut) appelée &ldquo;system&rdquo; est unique par machine et est normalement lancée par le processus d&rsquo;init avec les droits root.</p><p>On peut vérifier que systemd est bien l&rsquo;init <em>manager</em> du système de la façon suivante :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># ls -ls /usr/sbin/init</span>
</span></span><span class=line><span class=cl>/usr/sbin/init -&gt; /lib/systemd/systemd
</span></span></code></pre></td></tr></table></div></div><p>Ou plus simplement utiliser cette commande :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl
</span></span></code></pre></td></tr></table></div></div><p>La seconde est &ldquo;user&rdquo;, il est unique par utilisateur et hérite des mêmes droits que ce dernier.
Ce type d&rsquo;instance s&rsquo;avère particulièrement utile pour limiter les droits des services qui lui sont associés (rootless).</p><p>Pour connaître l&rsquo;état d&rsquo;une instance utilisateur on peut utiliser la commande suivante :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl --user
</span></span></code></pre></td></tr></table></div></div><p>Bien spécifier l&rsquo;argument <code>--user</code> devant toutes les commandes pour interagir avec l&rsquo;instance de l&rsquo;utilisateur.</p><h3 id=la-gestion-des-units>La gestion des Units<a hidden class=anchor aria-hidden=true href=#la-gestion-des-units>#</a></h3><p>On l&rsquo;a vu les <em>managers</em> sont responsables de la gestion des <em>units</em>.</p><p>Une <em>unit</em> chargée par un <em>manager</em> elle est unique si son nom est unique (pour les templates, les alias, les fragments, le nom est résolu au runtime).</p><p>Les <em>units files</em> sont lues au premier &ldquo;référencement&rdquo; (par exemple lors de leur activation, ou bien via de liens de dépendances&mldr;), transformées en <em>unit</em> et mise en cache dans la mémoire du <em>manager</em> qui leur est associé.</p><p>Elles sont stockées à l&rsquo;intérieur d&rsquo;une HashMap sous la forme nom/valeur (d&rsquo;où leur unicité).</p><p>Pour cette raison, il faut forcer le ramasse-miette (GC) ce qui a pour effet de sérialiser sur disque l&rsquo;état des <em>units</em> actives, vider le cache du manager et recharger la configuration des <em>units</em> via leurs <em>unit file</em> (ce n&rsquo;est pas néanmoins pas toujours nécessaire, mais ça évite des erreurs).</p><p>Pour forcer le ramasse miette on utilise la commande suivante :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl daemon-reload
</span></span></code></pre></td></tr></table></div></div><h3 id=arborescence-et-précédence>Arborescence et précédence<a hidden class=anchor aria-hidden=true href=#arborescence-et-précédence>#</a></h3><p>La définition des <em>unit files</em> répondent à une précédence très précise utilisée afin de faciliter l&rsquo;administration du système et sa mise à jour.</p><p>Par ordre d&rsquo;importance croissante (non exhaustif) en mode &ldquo;&ndash;system&rdquo; :</p><ul><li><code>/lib/systemd/system/*</code> : installés par le gestionnaire de paquets (il est recommandé d&rsquo;éviter de les modifier sous peine de pertes lors des mises à jour du paquet)</li><li><code>/usr/local/lib/systemd/system/*</code> : gérés par l&rsquo;administrateur</li><li><code>/run/systemd/system/*</code> : générées au runtime</li><li><code>/etc/systemd/system/*</code> : gérés par l&rsquo;administrateur</li></ul><p>Ainsi une <em>unit file</em> définie dans le répertoire <code>/etc/systemd/system/*</code> sera prioritaire sur celle définie dans <code>/lib/systemd/system/*</code></p><p>En mode &ldquo;&ndash;user&rdquo; la hiérarchie est un peu différente :</p><ul><li><code>/lib/systemd/user/*</code> : installés par le gestionnaire de paquets (ne doivent pas être modifiés sous peine de pertes lors des mises à jour)</li><li><code>/usr/local/lib/systemd/user/*</code> : gérés par l&rsquo;administrateur</li><li><code>/run/systemd/user/*</code> : générées au runtime</li><li><code>/etc/systemd/user/*</code> : gérés par l&rsquo;administrateur</li><li><code>~/.config/systemd/user/*</code> : géré par l&rsquo;utilisateur</li></ul><p>Ça peut paraître compliqué aux premiers abords, mais limite le périmètre des différents intervenants sur une machine (utilisateurs, administrateurs, packageurs&mldr;) pour qu&rsquo;ils ne se marchent sur les pieds.</p><p>De plus des outils spécifiques sont fournis (on le verra plus loin) pour aider à la compréhension de ce mécanisme.</p><h3 id=fragment-configuration>Fragment Configuration<a hidden class=anchor aria-hidden=true href=#fragment-configuration>#</a></h3><p>Les fragments configuration sont des fichiers qui permettent de modifier les propriétés d&rsquo;une ou d&rsquo;un groupe de <em>units</em> sans avoir à la/les redéfinir entièrement.
Ces fichiers répondent aux mêmes ordres de précédence que nous venons d&rsquo;aborder plus haut.</p><p>Pour surcharger, il est possible de définir des fichiers <code>.conf</code> qui seront lus par ordre alphabétique dans les formats suivants :</p><ul><li>Par type de <em>unit</em> sous la forme <code>&lt;unit_type>.d/*.conf</code>. Ainsi un fragment dans un répertoire <code>service.d/*.conf</code> s&rsquo;appliquera à tous les <code>*.service</code></li><li>Une <em>unit</em> spécifique sous la forme <code>&lt;unit_name>.d/*.conf</code></li><li>Ou grâce à une pseudo hiérarchie et l&rsquo;utilisation du signe &lsquo;-&rsquo; dans le nom des <em>units</em>. Ainsi un fragment de configuration dans le répertoire <code>foo-.d/*.conf</code> va surcharger les configurations des <em>units</em> <code>foo-bar.service</code>, <code>foo-foo.service</code> et <code>foo-bar-foo.service</code>&mldr;</li></ul><p>Voyons maintenant comment appliquer cela et les outils fournis par systemd pour nous assister dans la mise en place.</p><p>Si l&rsquo;on crée le fichier <code>/etc/systemd/system/service1.service</code> de la façon suivante :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>Type</span><span class=o>=</span><span class=s>oneshot</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>/bin/echo hello world</span>
</span></span></code></pre></td></tr></table></div></div><p>Puis le fragment de configuration dans le fichier suivant <code>/etc/systemd/system/service1.service.d/00-override.conf</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>/bin/echo running this first</span>
</span></span></code></pre></td></tr></table></div></div><p>Puis le fichier suivant <code>/etc/systemd/system/service.d/00-override.conf</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>/bin/echo top level exec pre start</span>
</span></span></code></pre></td></tr></table></div></div><p>On obtient en utilisant la commande <code>systemctl cat</code> le détail de la configuration de la <em>unit</em> ainsi que ses différents fragments :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ systemctl cat service1.service
</span></span><span class=line><span class=cl><span class=c1># /etc/systemd/system/service1.service</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>ExecPreStart</span><span class=o>=</span>/bin/echo hello world
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># /etc/systemd/system/service1.service.d/00-override.conf</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>ExecPreStart</span><span class=o>=</span>/bin/echo running this first
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># /etc/systemd/system/service.d/00-override.conf</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>ExecPreStart</span><span class=o>=</span>/bin/echo top level <span class=nb>exec</span> pre start
</span></span></code></pre></td></tr></table></div></div><p>Et produit le résultat suivant :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>top level exec pre start
</span></span><span class=line><span class=cl>running this first
</span></span><span class=line><span class=cl>hello world
</span></span></code></pre></td></tr></table></div></div><p>Il est intéressant de noter que les surcharges sont additives.
Pour passer outre les précédentes définitions, il faut d&rsquo;abord déclarer la propriété à vide avant de la surcharger avec la valeur attendue.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>/bin/echo top level exec pre start</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=les-units>Les Units<a hidden class=anchor aria-hidden=true href=#les-units>#</a></h2><p>Les <em>units</em> sont les éléments de bases de systemd.
Il existe 11 types différents de <em>unit</em>.
Ils correspondent chacun à un type d&rsquo;actions particulières.</p><p>Le type d&rsquo;une <em>unit</em> est déterminé par le suffix de son <em>unit file</em> :</p><ul><li>*.service : Qui permet de définir un groupe de processus. C&rsquo;est l&rsquo;objet qu&rsquo;on est le plus souvent amené à utiliser.</li><li>*.socket : Pour faire de l&rsquo;activation de services par sockets (IPC, network, unix socket&mldr;).</li><li>*.device : Pour prendre en compte l&rsquo;activation par périphériques via udev (dont le hot-plug).</li><li>*.mount : Pour gérer le montage de partitions.</li><li>*.automount : Qui permet l&rsquo;activation des <em>units</em> .mount automatique lors du premier accès.</li><li>*.swap : Configuration d&rsquo;un point de montage swap</li><li>*.target : Sont des point de synchronisation d&rsquo;un ensemble de <em>units</em> (comme les run-levels de SysVinit), mais également des points de déclenchements.</li><li>*.path : Activation par observation de chemins</li><li>*.timer : Déclencheur périodique (à la manière de cron)</li><li>*.scope : Configuration d&rsquo;un ensemble de processus externes</li><li>*.slice : Qui permet de regrouper un ensemble de processus au sein d&rsquo;un cgroup commun.</li></ul><p>Une <em>unit</em> est décrite par une <em>unit file</em> qui est lue au premier référencement pour être transformée en <em>unit</em>.</p><p>L&rsquo;objet <em>units</em> implémente les opérations de bases génériques, une spécialisation est faite via la structure <code>UnitVtable</code> qui va référencer les méthodes spécifiques à chaque type.</p><p>Voici un exemple non exhaustif des méthodes de <code>UnitVtable</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>UnitVTable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* How much memory does an object of this unit type need */</span>
</span></span><span class=line><span class=cl>        <span class=kt>size_t</span> <span class=n>object_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* The name of the configuration file section with the private settings of this unit */</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>private_section</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Config file sections this unit type understands, separated
</span></span></span><span class=line><span class=cl><span class=cm>         * by NUL chars */</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>sections</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* This should reset all type-specific variables. This should
</span></span></span><span class=line><span class=cl><span class=cm>         * not allocate memory, and is called with zero-initialized
</span></span></span><span class=line><span class=cl><span class=cm>         * data. It should hence only initialize variables that need
</span></span></span><span class=line><span class=cl><span class=cm>         * to be set != 0. */</span>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>init</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* This should free all type-specific variables. It should be
</span></span></span><span class=line><span class=cl><span class=cm>         * idempotent. */</span>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>done</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Actually load data from disk. This may fail, and should set
</span></span></span><span class=line><span class=cl><span class=cm>         * load_state to UNIT_LOADED, UNIT_MERGED or leave it at
</span></span></span><span class=line><span class=cl><span class=cm>         * UNIT_STUB if no configuration could be found. */</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>load</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>dump</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>,</span> <span class=n>FILE</span> <span class=o>*</span><span class=n>f</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>prefix</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>start</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>stop</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>reload</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>kill</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>,</span> <span class=n>KillWho</span> <span class=n>w</span><span class=p>,</span> <span class=kt>int</span> <span class=n>signo</span><span class=p>,</span> <span class=n>sd_bus_error</span> <span class=o>*</span><span class=n>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Boils down the more complex internal state of this unit to
</span></span></span><span class=line><span class=cl><span class=cm>         * a simpler one that the engine can understand */</span>
</span></span><span class=line><span class=cl>        <span class=nf>UnitActiveState</span> <span class=p>(</span><span class=o>*</span><span class=n>active_state</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Return false when there is a reason to prevent this unit from being gc&#39;ed
</span></span></span><span class=line><span class=cl><span class=cm>         * even though nothing references it and it isn&#39;t active in any way. */</span>
</span></span><span class=line><span class=cl>        <span class=kt>bool</span> <span class=p>(</span><span class=o>*</span><span class=n>may_gc</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Return true when the unit is not controlled by the manager (e.g. extrinsic mounts). */</span>
</span></span><span class=line><span class=cl>        <span class=kt>bool</span> <span class=p>(</span><span class=o>*</span><span class=n>is_extrinsic</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Returns the exit status to propagate in case of FailureAction=exit/SuccessAction=exit; usually returns the
</span></span></span><span class=line><span class=cl><span class=cm>         * exit code of the &#34;main&#34; process of the service or similar. */</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>exit_status</span><span class=p>)(</span><span class=n>Unit</span> <span class=o>*</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>.....</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>UnitVTable</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>On retrouve logiquement dans l&rsquo;objet Unit l&rsquo;ensemble des sous-types, qui permettra de propager les actions génériques vers leurs implementations.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>const</span> <span class=n>UnitVTable</span> <span class=o>*</span> <span class=k>const</span> <span class=n>unit_vtable</span><span class=p>[</span><span class=n>_UNIT_TYPE_MAX</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_SERVICE</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>service_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_SOCKET</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>socket_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_TARGET</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>target_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_DEVICE</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>device_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_MOUNT</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>mount_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_AUTOMOUNT</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>automount_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_SWAP</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>swap_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_TIMER</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>timer_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_PATH</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>path_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_SLICE</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>slice_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>UNIT_SCOPE</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>scope_vtable</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>Un <em>unit</em> a un cycle de vie, et donc un état. Les états de base sont les suivants :</p><ul><li>Active</li><li>Reloading</li><li>Inactive</li><li>Failed</li><li>Activating</li><li>Deactivating</li><li>Maintenance</li></ul><p>Cette liste d&rsquo;état peut être, elle aussi, enrichie pour répondre au cycle de vie spécifique d&rsquo;un type d&rsquo;<em>unit</em>.</p><p>Par exemple pour une <em>unit</em> de type service on trouve cette liste d&rsquo;états qui font tous la correspondance avec les états de base.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=n>UnitActiveState</span> <span class=n>state_translation_table</span><span class=p>[</span><span class=n>_SERVICE_STATE_MAX</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_DEAD</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_INACTIVE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_CONDITION</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_ACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_START_PRE</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_ACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_START</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_ACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_START_POST</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_ACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_RUNNING</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_ACTIVE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_EXITED</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_ACTIVE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_RELOAD</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_RELOADING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_STOP</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_DEACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_STOP_WATCHDOG</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_DEACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_STOP_SIGTERM</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_DEACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_STOP_SIGKILL</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_DEACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_STOP_POST</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_DEACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_FINAL_WATCHDOG</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_DEACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_FINAL_SIGTERM</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_DEACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_FINAL_SIGKILL</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_DEACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_FAILED</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_FAILED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_AUTO_RESTART</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_ACTIVATING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>SERVICE_CLEANING</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_MAINTENANCE</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=job-et-transaction>Job et Transaction<a hidden class=anchor aria-hidden=true href=#job-et-transaction>#</a></h2><p>Tout changement d&rsquo;état d&rsquo;une <em>unit</em> se fait au travers d&rsquo;un Job.
Il existe plusieurs types de job :</p><ul><li>Start / Verify</li><li>Stop</li><li>Reload</li><li>Restart</li><li>Nop</li></ul><p>On trouve également d&rsquo;autres types de Job qui sont la combinaison des types précédents :
par exemple &ldquo;try-restart&rdquo; se transformera à l&rsquo;exécution en &ldquo;start&rdquo; ou &ldquo;nop&rdquo; si la <em>unit</em> n&rsquo;est pas activée ou en cours de rechargement.</p><p>Prenons l&rsquo;exemple de la <em>unit file</em> suivante :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Unit]</span>
</span></span><span class=line><span class=cl><span class=na>Wants</span><span class=o>=</span><span class=s>multi-users.target</span>
</span></span><span class=line><span class=cl><span class=na>...</span>
</span></span></code></pre></td></tr></table></div></div><p>La propriété <code>Wants=</code> a pour effet de créer une dépendance entre cette <em>unit</em> et la target <em>unit</em> &ldquo;multi-user.target&rdquo;.</p><p>NB : La plupart des relations peuvent être notées dans un sens ou dans l&rsquo;autre (<code>Before=</code>/ <code>After=</code>, <code>Require=</code>/<code>RequiredBy=</code>&mldr;)
On pourrait donc réaliser cette même dépendance à l&rsquo;aide de la propriété <code>WantedBy=</code> dans la target et cela aurait le même effet.</p><p>Cette dépendance va avoir pour effet de propager l&rsquo;activation de la target &ldquo;multi-user.target&rdquo; aux <em>unit</em> ayant une relation de type <code>Wants=</code> avec elle.</p><p>Lors de cette activation une transaction qui va contenir le job d&rsquo;activation de la target en elle-même plus autant de job que de dépendances.</p><p>Ainsi dans le cas d&rsquo;une relation avec une <em>unit</em> de type <code>Wants=</code> la transaction pourra être mise en succès même si ce job est en échec.
Ce qui n&rsquo;aurait pas été le cas avec une relation plus &ldquo;forte&rdquo; (par exemple <code>Require=</code>/<code>RequiredBy=</code>).</p><p>En pratique ces relations sont spécifiées par une énumération de propriétés beaucoup plus fines les <code>UnitDependencyAtom</code> ou &ldquo;atoms&rdquo; (qui ne sont rien d&rsquo;autre qu&rsquo;un bitmask).</p><p>Ainsi la propriété <code>Wants=</code> est composée de la sorte :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=p>[</span><span class=n>UNIT_WANTS</span><span class=p>]</span> <span class=o>=</span> <span class=n>UNIT_ATOM_PULL_IN_START_IGNORED</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>               <span class=n>UNIT_ATOM_RETROACTIVE_START_FAIL</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>               <span class=n>UNIT_ATOM_ADD_STOP_WHEN_UNNEEDED_QUEUE</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>               <span class=n>UNIT_ATOM_ADD_DEFAULT_TARGET_DEPENDENCY_QUEUE</span><span class=p>,</span>
</span></span></code></pre></td></tr></table></div></div><p>Cela lui permet de réagir aux propriétés suivantes qui peuvent être utilisées par différents objets (transaction, units&mldr;).
Sans rentrer dans les détails on retrouve l&rsquo;attribut &ldquo;UNIT_ATOM_PULL_IN_START_IGNORED&rdquo; le comportement décrit plus haut.</p><p>Il implémente un mécanisme de transaction connu sous le nom de Job qui s&rsquo;assure de la transition d&rsquo;une <em>unit</em> d&rsquo;un état A vers un état B (par exemple start / stop / restart&mldr;).</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Vous l&rsquo;avez peut-être remarqué, mais systemd est conçu comme un système orienté objet.
On retrouve d&rsquo;ailleurs beaucoup de principes de la POO (polymorphisme, sous-typage, redéfinition&mldr;) dans les différents points que j&rsquo;ai abordés</p><p>Voilà ainsi va se conclure cet article.
Dans le prochain, nous aborderons l&rsquo;architecture de systemd.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://cyrillesondag.github.io/tags/linux/>Linux</a></li><li><a href=https://cyrillesondag.github.io/tags/systemd/>Systemd</a></li></ul><nav class=paginav><a class=prev href=https://cyrillesondag.github.io/blog/systemd-part-three/><span class=title>« Prev</span><br><span>Systemd - partie 3</span>
</a><a class=next href=https://cyrillesondag.github.io/blog/systemd-part-one/><span class=title>Next »</span><br><span>Systemd - partie 1</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Systemd - partie 2 on x" href="https://x.com/intent/tweet/?text=Systemd%20-%20partie%202&amp;url=https%3a%2f%2fcyrillesondag.github.io%2fblog%2fsystemd-part-two%2f&amp;hashtags=linux%2csystemd"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Systemd - partie 2 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcyrillesondag.github.io%2fblog%2fsystemd-part-two%2f&amp;title=Systemd%20-%20partie%202&amp;summary=Systemd%20-%20partie%202&amp;source=https%3a%2f%2fcyrillesondag.github.io%2fblog%2fsystemd-part-two%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Systemd - partie 2 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcyrillesondag.github.io%2fblog%2fsystemd-part-two%2f&title=Systemd%20-%20partie%202"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Systemd - partie 2 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcyrillesondag.github.io%2fblog%2fsystemd-part-two%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Systemd - partie 2 on whatsapp" href="https://api.whatsapp.com/send?text=Systemd%20-%20partie%202%20-%20https%3a%2f%2fcyrillesondag.github.io%2fblog%2fsystemd-part-two%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Systemd - partie 2 on telegram" href="https://telegram.me/share/url?text=Systemd%20-%20partie%202&amp;url=https%3a%2f%2fcyrillesondag.github.io%2fblog%2fsystemd-part-two%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Systemd - partie 2 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Systemd%20-%20partie%202&u=https%3a%2f%2fcyrillesondag.github.io%2fblog%2fsystemd-part-two%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>© {year}</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>